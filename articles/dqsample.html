<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>dqsample: A bias-free alternative to R’s ‘sample’ function • dqsample</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="dqsample: A bias-free alternative to R’s ‘sample’ function">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dqsample</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/dqsample.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/daqana/dqsample">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>dqsample: A bias-free alternative to R’s ‘sample’ function</h1>
                        <h4 class="author">Ralf Stubner</h4>
            
            <h4 class="date">2018-10-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/daqana/dqsample/blob/master/vignettes/dqsample.Rmd"><code>vignettes/dqsample.Rmd</code></a></small>
      <div class="hidden name"><code>dqsample.Rmd</code></div>

    </div>

    
    
<p>For many tasks in statistics and data science it is useful to create a random sample or permutation of a data set. Within R the function <code><a href="http://www.rdocumentation.org/packages/base/topics/sample">base::sample()</a></code> is used for this task. Unfortunately this function uses a slightly biased algorithm for creating random integers within a given range. Most recently this issue has been discussed in a <a href="https://stat.ethz.ch/pipermail/r-devel/2018-September/076817.html">thread on R-devel</a>, which is also the motivation of the dqsample package.</p>
<div id="example-for-the-bias" class="section level2">
<h2 class="hasAnchor">
<a href="#example-for-the-bias" class="anchor"></a>Example for the bias</h2>
<p>When sampling many random integers the density of odd and even numbers should be roughly equal and constant. However, this is not the case with <code><a href="http://www.rdocumentation.org/packages/base/topics/sample">base::sample</a></code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">m &lt;-<span class="st"> </span><span class="dv">2</span><span class="op">/</span><span class="dv">5</span> <span class="op">*</span><span class="st"> </span><span class="dv">2</span><span class="op">^</span><span class="dv">32</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">x &lt;-<span class="st"> </span>base<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="kw">floor</span>(m), <span class="dv">1000000</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">plot</span>(<span class="kw">density</span>(x[x <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>]), <span class="dt">main =</span> <span class="st">"base::sample"</span>, <span class="dt">xlab =</span> <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">lines</span>(<span class="kw">density</span>(x[x <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">1</span>]), <span class="dt">col =</span> <span class="st">"#FF8F00"</span>)</a></code></pre></div>
<p><img src="dqsample_files/figure-html/base-1.png" width="576"></p>
<p>Or with slightly different parameters:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">x &lt;-<span class="st"> </span>base<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="kw">floor</span>(m <span class="op">-</span><span class="st"> </span><span class="dv">2</span>), <span class="dv">1000000</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">plot</span>(<span class="kw">density</span>(x[x <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>]), <span class="dt">main =</span> <span class="st">"base::sample"</span>, <span class="dt">xlab =</span> <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">lines</span>(<span class="kw">density</span>(x[x <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">1</span>]), <span class="dt">col =</span> <span class="st">"#FF8F00"</span>)</a></code></pre></div>
<p><img src="dqsample_files/figure-html/base-oszi-1.png" width="576"></p>
<p>This particular example for the bias was found by <a href="https://stat.ethz.ch/pipermail/r-devel/2018-September/076827.html">Duncan Murdoch</a>.</p>
<p>In dqsample the algorithm suggested by Daniel Lemire (2018, &lt;<a href="https://arxiv.org/abs/1805.10941">arXiv:1805.1094</a>&gt;) is used. With this algorithm there is no observable bias between odd and even numbers:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">m &lt;-<span class="st"> </span><span class="dv">2</span><span class="op">/</span><span class="dv">5</span> <span class="op">*</span><span class="st"> </span><span class="dv">2</span><span class="op">^</span><span class="dv">32</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">x &lt;-<span class="st"> </span>dqsample<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dqsample/topics/sample">sample</a></span>(<span class="kw">floor</span>(m), <span class="dv">1000000</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">plot</span>(<span class="kw">density</span>(x[x <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>]), <span class="dt">main =</span> <span class="st">"dqsample::sample"</span>, <span class="dt">xlab =</span> <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">lines</span>(<span class="kw">density</span>(x[x <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">1</span>]), <span class="dt">col =</span> <span class="st">"#FF8F00"</span>)</a></code></pre></div>
<p><img src="dqsample_files/figure-html/dqsample-1.png" width="576"></p>
</div>
<div id="where-does-the-bias-come-from" class="section level2">
<h2 class="hasAnchor">
<a href="#where-does-the-bias-come-from" class="anchor"></a>Where does the bias come from?</h2>
<p>Internally the <code><a href="http://www.rdocumentation.org/packages/base/topics/sample">base::sample()</a></code> function needs uniformly distributed random integers in an half-open range <code>[0, n)</code>. In order to do so, R uses random floating point numbers that are uniformly distributed in <code>[0, 1)</code>, multiplies by <code>n</code> and truncates the result to the next smaller integer. This method would be fine, if the random numbers used as starting point would be real numbers in the mathematical sense. However, this is not the case here.</p>
<p>The default random-number generator in R is a 32 bit version of the Mersenne-Twister. It produces random integers uniformly distributed in <code>[0, 2^32)</code>, which are then divided by <code>2^32</code> to produce doubles in <code>[0, 1)</code>. We can now invert the procedure described above to see how many integers are mapped to a certain result. For example, we could simulate rolling ten dice using <code><a href="../reference/sample.html">sample(6, 10, replace = TRUE)</a></code>. Since <code>2^32</code> is not a multiple of six, the distribution cannot be completely even:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">possible_integers &lt;-<span class="st"> </span><span class="cf">function</span>(n, <span class="dt">limit =</span> n) {</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  result &lt;-<span class="st"> </span><span class="kw">diff</span>(<span class="kw">floor</span>(<span class="dv">2</span><span class="op">^</span><span class="dv">32</span> <span class="op">*</span><span class="st"> </span><span class="kw">seq.int</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> limit) <span class="op">/</span><span class="st"> </span>n))</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="kw">names</span>(result) &lt;-<span class="st"> </span><span class="kw">seq.int</span>(<span class="dt">to =</span> limit)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  result</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="kw">possible_integers</span>(<span class="dv">6</span>)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#&gt;         1         2         3         4         5         6 </span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co">#&gt; 715827882 715827883 715827883 715827882 715827883 715827883</span></a></code></pre></div>
<p>We see that both one and four are <em>very slightly</em> less likely than the other numbers. This effect gets much more pronounced as the number of items increases from which one can choose. For example, we can use the <code>m</code> from above to see how that uneven distribution of odd and even numbers came about:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">possible_integers</span>(<span class="kw">floor</span>(m), <span class="dt">limit =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">#&gt;  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 </span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">#&gt;  2  3  2  3  2  3  2  3  2  3  2  3  2  3  2  3  2  3  2  3</span></a></code></pre></div>
<p>Here we see that while only two integers map to any odd number, there are three integers mapped to the even numbers. This pattern shifts half way through the possible results, making the odd numbers more likely, leading to the first image displayed above. As one goes away from <code>m</code>, these pattern shifts occur more rapidly, leading to the oscillatory behaviour seen in the second image. As one moves further away from <code>m</code>, these oscillations happen so rapidly, that a density plot of odd and even numbers looks constant, but the bias is still there. For example, for <code>m - 2^20</code> one such pattern shift happens between 982 and 983:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">tail</span>(<span class="kw">possible_integers</span>(<span class="kw">floor</span>(m <span class="op">-</span><span class="st"> </span><span class="dv">2</span><span class="op">^</span><span class="dv">20</span>), <span class="dt">limit =</span> <span class="dv">992</span>), <span class="dt">n =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#&gt; 973 974 975 976 977 978 979 980 981 982 983 984 985 986 987 988 989 990 </span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co">#&gt;   2   3   2   3   2   3   2   3   2   3   3   2   3   2   3   2   3   2 </span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">#&gt; 991 992 </span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co">#&gt;   3   2</span></a></code></pre></div>
<p>Below this point, even numbers are more likely than odd numbers. After this point, the pattern is reversed.</p>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>The algorithm used by <code><a href="http://www.rdocumentation.org/packages/base/topics/sample">base::sample()</a></code> is biased with non-negligible effects when sampling from large data sets. The dqsample package provides an unbiased algorithm for the most common cases. It can be used as a drop-in replacement for the functionality provided by <code><a href="http://www.rdocumentation.org/packages/base/topics/sample">base::sample()</a></code>.</p>
<!-- ```{r} -->
<!-- possible_integers(floor(2^32 / 12.34), limit = 20) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- possible_integers(floor(2/3 * 2^32), limit = 20) -->
<!-- diff(floor(2^32 * 0:6 / 6)) -->
<!-- 1/715827883 -->
<!-- matrix(diff(floor(2^32 * 0:52 / 52)), 13, 4) -->
<!-- matrix((sprintf("%a", 0:51 / 52)), 13, 4) -->
<!-- diff(floor(2^32 * 0:20 / floor(2/5 * 2^32))) -->
<!-- 2^32 * 0:52 / (2/5 * 2^32) -->
<!-- 2^32 * 0:52 / (2/3 * 2^32) -->
<!-- ``` -->
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#example-for-the-bias">Example for the bias</a></li>
      <li><a href="#where-does-the-bias-come-from">Where does the bias come from?</a></li>
      <li><a href="#conclusion">Conclusion</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Ralf Stubner.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
